# 网络模块源代码

本目录包含网络模块的核心实现代码，提供 Avalanche 节点间通信的功能。

## 文件结构

- `lib.rs`: 模块入口点，定义公共 API 和类型
- `peer/`: 对等节点管理子模块
  - `mod.rs`: 对等节点模块入口，定义通用类型和接口
  - `inbound.rs`: 入站连接处理
  - `outbound.rs`: 出站连接管理

## 详细说明

### lib.rs

模块的主入口文件，定义了以下内容：

- 公共 API 和类型导出
- 模块级文档
- 子模块组织

这个文件保持简洁，主要功能实现都在子模块中。

### peer/mod.rs

对等节点模块的入口文件，定义了以下内容：

1. **Peer 类型**
   - 表示网络中的一个对等节点
   - 包含连接状态、地址信息等

2. **通用接口**
   - 消息发送和接收
   - 连接管理
   - 节点状态查询

3. **错误类型**
   - 网络错误定义
   - 错误处理机制

### peer/inbound.rs

处理入站连接的实现，包含以下功能：

1. **连接接收**
   - 监听网络端口
   - 接受新连接

2. **TLS 握手**
   - 验证客户端证书
   - 建立安全连接

3. **连接处理**
   - 创建 Peer 对象
   - 管理连接生命周期

### peer/outbound.rs

管理出站连接的实现，包含以下功能：

1. **连接建立**
   - 连接到远程节点
   - 处理连接超时

2. **TLS 客户端**
   - 配置 TLS 客户端
   - 验证服务器证书

3. **连接池管理**
   - 维护活跃连接
   - 连接复用和负载均衡

## 设计模式

1. **工厂模式**
   - 用于创建 Peer 对象
   - 例如 `Peer::new()` 方法

2. **观察者模式**
   - 用于网络事件通知
   - 连接状态变化通知

3. **策略模式**
   - 可插拔的网络传输协议
   - 支持不同的连接类型

4. **单例模式**
   - 用于全局网络管理器
   - 确保资源的统一管理

## 使用示例

```rust
// 创建 TLS 连接器
let connector = outbound::Connector::new_from_pem(&client_key_path, &client_cert_path)?;

// 连接到远程节点
let stream = connector.connect(remote_addr, Duration::from_secs(5))?;

// 创建 Peer 对象
let peer = Peer::new(stream);

// 发送消息
peer.send(message).await?;

// 接收消息
let response = peer.receive().await?;
```

## 错误处理

模块使用自定义错误类型处理各种网络错误：

- 连接错误
- TLS 错误
- 超时错误
- 消息格式错误

所有公共函数都返回 `Result` 类型，便于错误传播和处理。

## 依赖关系

主要依赖以下外部库：

- `tokio`: 异步运行时
- `rustls`: TLS 实现
- `cert-manager`: 证书管理
- `bytes`: 高效字节处理

## 未来改进

1. 实现节点发现机制
2. 添加 NAT 穿透支持
3. 优化网络拓扑管理
4. 实现更高效的消息路由

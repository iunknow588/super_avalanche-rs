# Avalanche 脚本工具集

本目录包含 Avalanche 项目的各种脚本工具，用于自动化构建、测试、代码质量检查等任务。这些脚本是开发工作流程的重要组成部分，确保代码质量和项目的可靠性。

## 目录

1. [脚本概述](#脚本概述)
2. [设计模式](#设计模式)
3. [构建脚本](#构建脚本)
4. [代码质量脚本](#代码质量脚本)
5. [测试脚本](#测试脚本)
6. [使用指南](#使用指南)

## 脚本概述

Avalanche 脚本工具集包含以下几类脚本：

1. **构建脚本**：用于编译和打包项目
2. **代码质量脚本**：用于代码格式化、静态分析和质量检查
3. **测试脚本**：用于运行各种类型的测试，包括单元测试、集成测试、端到端测试等

这些脚本共同构成了一个完整的开发工作流程，确保代码质量和项目的可靠性。

## 设计模式

### 模块化设计

脚本工具集采用模块化设计，将不同功能的脚本分离：

- 每个脚本专注于单一职责
- 复杂任务通过组合多个脚本实现
- 脚本之间可以相互调用，形成层次结构

### 自动化工作流

脚本工具集实现了开发工作流程的自动化：

- 自动化构建过程
- 自动化测试执行
- 自动化代码质量检查

### 错误处理机制

脚本工具集实现了健壮的错误处理机制：

- 使用 `set -e` 确保一旦出错立即退出
- 使用 `set -u` 确保使用未定义变量时报错
- 使用 `set -x` 输出执行的命令，便于调试

### 可配置性

脚本工具集提供了高度的可配置性：

- 通过环境变量配置脚本行为
- 通过命令行参数传递配置
- 支持默认配置和自定义配置

## 构建脚本

### build.release.sh

**功能**：构建项目的发布版本

**实现细节**：
- 使用 `cargo build --release` 命令构建优化的发布版本
- 指定构建特定的包 (`-p` 参数)，包括 `avalanche-types` 和 `avalanche-consensus`
- 包含路径检查，确保脚本从仓库根目录运行

**使用场景**：
- 准备生产环境部署
- 性能测试和基准测试
- 创建可分发的二进制文件

### check_crate_version.sh

**功能**：检查 Rust crate 的版本信息

**实现细节**：
- 比对本地 crate 版本和远程仓库的版本
- 确保依赖项是最新或符合要求的版本
- 支持版本兼容性检查

**使用场景**：
- 发布前的版本检查
- 依赖项管理
- CI/CD 流程中的版本验证

## 代码质量脚本

### format.sh

**功能**：检查代码格式是否符合规范

**实现细节**：
- 使用 `rustfmt` 工具检查代码格式
- 排除自动生成的代码和第三方代码
- 使用 `.rustfmt.toml` 配置文件定义格式规则
- 使用 `--check` 参数只检查不修改代码

**使用场景**：
- 代码提交前的格式检查
- CI/CD 流程中的格式验证
- 确保团队代码风格一致

### clippy.sh

**功能**：运行 Rust 静态分析工具 Clippy 检查代码质量

**实现细节**：
- 使用 `cargo clippy` 工具进行静态分析
- 配置多种 lint 规则，包括可疑代码、风格、复杂度、性能等
- 处理自动生成文件中的重复属性问题
- 输出详细的检查结果到日志文件

**使用场景**：
- 代码提交前的质量检查
- CI/CD 流程中的质量验证
- 发现潜在的代码问题和优化机会

### tests.lint.sh

**功能**：组合运行格式检查和静态分析

**实现细节**：
- 调用 `format.sh` 进行格式检查
- 调用 `clippy.sh` 进行静态分析
- 清理构建产物，确保下次构建的干净环境

**使用场景**：
- 代码提交前的全面质量检查
- CI/CD 流程中的质量验证
- 一键运行所有代码质量检查

### tests.unused.sh

**功能**：检查代码中未使用的依赖项

**实现细节**：
- 使用 `cargo-udeps` 工具检查未使用的依赖项
- 支持检查所有特性和测试代码
- 输出详细的未使用依赖项列表

**使用场景**：
- 代码清理和优化
- 减少项目依赖项
- 提高构建速度和减小二进制大小

## 测试脚本

### tests.unit.sh

**功能**：运行单元测试

**实现细节**：
- 使用 `cargo test` 命令运行单元测试
- 启用所有特性 (`--all-features`)
- 设置日志级别为 `debug`，提供详细的测试输出
- 指定测试特定的包，包括 `avalanche-types` 和 `avalanche-consensus`

**使用场景**：
- 验证各个模块的正确性
- 开发过程中的快速反馈
- CI/CD 流程中的基本测试

### tests.fuzz.sh

**功能**：运行模糊测试

**实现细节**：
- 使用 `cargo fuzz` 工具运行模糊测试
- 支持多种模糊测试目标
- 配置测试时间和迭代次数

**使用场景**：
- 发现边缘情况和异常输入
- 提高代码的健壮性
- 安全性测试

### tests.avalanchego-e2e.sh

**功能**：运行端到端测试

**实现细节**：
- 下载和配置 `avalanche-network-runner` 工具
- 启动测试网络环境
- 构建和运行 `avalanche-e2e` 测试工具
- 支持自定义测试参数和配置
- 测试完成后自动清理资源

**使用场景**：
- 验证系统的整体功能
- 模拟真实用户场景
- 集成测试和验收测试

### tests.avalanchego-byzantine.sh

**功能**：运行拜占庭容错测试

**实现细节**：
- 配置测试环境和依赖
- 运行模拟恶意节点的测试
- 验证系统在异常情况下的行为

**使用场景**：
- 验证系统的安全性和鲁棒性
- 测试共识算法的容错能力
- 模拟网络攻击和异常情况

### tests.avalanchego-conformance.sh

**功能**：运行一致性测试

**实现细节**：
- 配置测试环境和依赖
- 运行验证协议一致性的测试
- 比较不同实现之间的行为

**使用场景**：
- 验证与协议规范的一致性
- 确保不同实现之间的互操作性
- 验证协议升级的兼容性

## 使用指南

### 基本用法

所有脚本都应该从仓库根目录运行：

```bash
# 构建发布版本
./scripts/build.release.sh

# 运行代码质量检查
./scripts/tests.lint.sh

# 运行单元测试
./scripts/tests.unit.sh
```

### 高级用法

某些脚本支持通过环境变量或命令行参数进行配置：

```bash
# 使用自定义 AvalancheGo 路径运行端到端测试
./scripts/tests.avalanchego-e2e.sh ~/go/src/github.com/ava-labs/avalanchego/build/avalanchego

# 使用 AWS KMS 签名运行端到端测试
E2E_FLAGS="--sign-with-kms-aws" ./scripts/tests.avalanchego-e2e.sh
```

### CI/CD 集成

这些脚本可以轻松集成到 CI/CD 流程中：

```yaml
# GitHub Actions 示例
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: 代码质量检查
        run: ./scripts/tests.lint.sh
      - name: 单元测试
        run: ./scripts/tests.unit.sh
      - name: 端到端测试
        run: ./scripts/tests.avalanchego-e2e.sh
```
